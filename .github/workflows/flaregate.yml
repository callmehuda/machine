name: Docker CI - FlareGate

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Checkout the code
    - name: Checkout code
      uses: actions/checkout@v3

    # Step 2: Set up Docker
    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    # Step 3: Pull the FlareGate Docker image
    - name: Pull FlareGate Docker image
      run: |
        docker pull ghcr.io/rickicode/flaregate:sha-8653942

    # Step 4: Run the FlareGate Docker container
    - name: Run FlareGate Docker container
      run: |
        docker run -d -p 8020:8020 --name flaregate-container ghcr.io/rickicode/flaregate:sha-8653942
        # Ensure FlareGate is running
        sleep 10  # Wait a few seconds for the server to start

    # Step 5: Verify that the service is accessible
    - name: Test FlareGate Dashboard
      run: |
        curl --silent --fail http://localhost:8020 || exit 1  # Fail if the service is not accessible

    # Step 6: Cleanup
    - name: Clean up Docker container
      run: |
        docker stop flaregate-container
        docker rm flaregate-container

  # Optional: Testing with more advanced checks
  test:
    runs-on: ubuntu-latest
    needs: build  # This job runs after the 'build' job is successful
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      # Step 1: Run FlareGate Docker container again (if necessary for testing)
      - name: Run FlareGate Docker container
        run: |
          docker run -d -p 8020:8020 --name flaregate-container ghcr.io/rickicode/flaregate:sha-8653942
          sleep 10  # Wait for the application to start

      # Step 2: Test if the FlareGate dashboard is reachable
      - name: Test FlareGate Dashboard Access
        run: |
          curl --silent --fail http://localhost:8020 || exit 1

      # Step 3: Clean up after tests
      - name: Clean up Docker container
        run: |
          docker stop flaregate-container
          docker rm flaregate-container